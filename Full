using UnityEngine;
using UnityEngine.UI;
using UnityEngine.EventSystems;
using System.Collections;
using System.Collections.Generic;
using System.IO;
using Newtonsoft.Json; // Giả sử đã import Json.NET cho save system
using UnityEngine.AI; // Cho AI

namespace FreeFireMaster.Core
{
    // ========================================================
    // 1. DATA STRUCTURES & ENUMS (ĐỊNH NGHĨA DỮ LIỆU NÂNG CAO)
    // ========================================================
    public enum PlayerState { Parachuting, Walking, Crouching, Prone, Swimming, Driving, Dead }
    public enum WeaponType { Rifle, Sniper, Shotgun, SMG, Pistol, Melee }
    public enum TerrainType { Grass, Wood, Metal, Water, Sand }
    public enum ItemType { Weapon, Attachment, Ammo, Medkit, Armor, Skin }

    [System.Serializable]
    public class WeaponAttachment
    {
        public string attachmentName;
        public ItemType attachmentType;
        public float zoomLevel = 1f;
        public float stabilityBonus = 0.2f; // Giảm độ giật
        public float damageBonus = 0f;
        public int ammoBonus = 0;
    }

    [System.Serializable]
    public class WeaponSystem
    {
        public string gunName;
        public WeaponType type;
        public float baseDamage = 30f;
        public float fireRate = 0.1f;
        public int magSize = 30;
        public int currentAmmo;
        public float recoilVertical = 1.5f;
        public float recoilHorizontal = 0.8f;
        public float spread = 0.05f;
        public List<WeaponAttachment> equippedAttachments = new List<WeaponAttachment>();
        public AudioClip shootSound;
        public AudioClip reloadSound;
        public ParticleSystem muzzleFlash;
    }

    [System.Serializable]
    public class InventoryItem
    {
        public string itemName;
        public ItemType type;
        public int quantity = 1;
        public WeaponAttachment attachmentData; // Nếu là attachment
        public WeaponSystem weaponData; // Nếu là weapon
    }

    [System.Serializable]
    public class PlayerSaveData
    {
        public float gold = 0f;
        public List<string> unlockedSkins = new List<string>();
        public List<InventoryItem> savedInventory = new List<InventoryItem>();
    }

    // ========================================================
    // 2. MASTER CONTROLLER (HỆ THỐNG ĐIỀU KHIỂN TỔNG - NÂNG CAO)
    // ========================================================
    [RequireComponent(typeof(CharacterController))]
    public class PlayerMaster : MonoBehaviour
    {
        #region Header Variables - Survival & State
        [Header("Survival Stats")]
        public float maxHealth = 200f;
        public float health = 200f;
        public float maxArmor = 100f;
        public float armor = 100f;
        public float maxStamina = 100f;
        public float stamina = 100f;
        public PlayerState currentState = PlayerState.Parachuting;
        public bool isCrouching = false;
        public bool isProne = false;
        #endregion

        #region Header Variables - Movement
        [Header("Movement Settings")]
        public float walkSpeed = 7f;
        public float sprintSpeed = 12f;
        public float crouchSpeed = 4f;
        public float proneSpeed = 2f;
        public float swimSpeed = 5f;
        public float mouseSensitivity = 2f;
        public float jumpHeight = 2.5f;
        public float gravity = -19.6f;
        #endregion

        #region Header Variables - Combat
        [Header("Combat References")]
        public List<WeaponSystem> weaponInventory = new List<WeaponSystem>(3); // Max 3 slots
        public int activeSlot = 0;
        public Camera mainCam;
        public Transform weaponHoldPoint;
        public float nextShotTime = 0f;
        public bool isReloading = false;
        #endregion

        #region Header Variables - Vehicle & Inventory
        [Header("Vehicle System")]
        public bool isInVehicle = false;
        public GameObject currentVehicle;

        [Header("Inventory & UI")]
        public Canvas inventoryCanvas;
        public GridLayoutGroup inventoryGrid;
        public List<InventoryItem> backpack = new List<InventoryItem>();
        public int maxBackpackSlots = 20;
        #endregion

        #region Private Variables
        private CharacterController controller;
        private Vector3 velocity;
        private float rotationX = 0f;
        private bool isGrounded;
        private TerrainType currentTerrain = TerrainType.Grass;
        private SoundManager soundManager;
        #endregion

        void Start()
        {
            controller = GetComponent<CharacterController>();
            Cursor.lockState = CursorLockMode.Locked;
            Cursor.visible = false;
            soundManager = FindObjectOfType<SoundManager>();
            InitializeGameData();
            LoadPlayerData();
        }

        void InitializeGameData()
        {
            // Khởi tạo AK47 mặc định
            WeaponSystem ak = new WeaponSystem 
            { 
                gunName = "AK47", 
                type = WeaponType.Rifle,
                baseDamage = 38f,
                currentAmmo = 30,
                magSize = 30,
                recoilVertical = 2f,
                recoilHorizontal = 1f,
                spread = 0.1f
            };
            ak.equippedAttachments.Add(new WeaponAttachment { attachmentName = "X4 Scope", attachmentType = ItemType.Attachment, zoomLevel = 30f });
            weaponInventory.Add(ak);

            // Thêm item mẫu vào backpack
            backpack.Add(new InventoryItem { itemName = "Medkit", type = ItemType.Medkit, quantity = 3 });
        }

        void Update()
        {
            if (health <= 0) { currentState = PlayerState.Dead; return; }

            switch (currentState)
            {
                case PlayerState.Parachuting:
                    HandleParachuteLogic();
                    break;
                case PlayerState.Walking:
                case PlayerState.Crouching:
                case PlayerState.Prone:
                    HandleMouseLook();
                    HandleMovement();
                    HandleCombat();
                    HandleCrouchProne();
                    HandleInventoryInput();
                    break;
                case PlayerState.Swimming:
                    HandleSwimLogic();
                    break;
                case PlayerState.Driving:
                    HandleVehicleExit();
                    break;
            }

            UpdateTerrainType(); // Để chơi âm thanh bước chân phù hợp
        }

        // --- HÀM DI CHUYỂN WASD NÂNG CAO ---
        void HandleMovement()
        {
            isGrounded = controller.isGrounded;
            if (isGrounded && velocity.y < 0) velocity.y = -2f;

            float x = Input.GetAxis("Horizontal");
            float z = Input.GetAxis("Vertical");

            float speed = GetCurrentSpeed();
            Vector3 move = transform.right * x + transform.forward * z;
            controller.Move(move.normalized * speed * Time.deltaTime);

            if (Input.GetButtonDown("Jump") && isGrounded && !isProne)
                velocity.y = Mathf.Sqrt(jumpHeight * -2f * gravity);

            velocity.y += gravity * Time.deltaTime;
            controller.Move(velocity * Time.deltaTime);

            // Phát âm thanh bước chân nếu di chuyển
            if (move.magnitude > 0.1f && isGrounded)
            {
                soundManager.PlayFootstepSound(currentTerrain, transform.position);
            }
        }

        float GetCurrentSpeed()
        {
            if (currentState == PlayerState.Swimming) return swimSpeed;
            if (isProne) return proneSpeed;
            if (isCrouching) return crouchSpeed;
            return Input.GetKey(KeyCode.LeftShift) && stamina > 0 ? sprintSpeed : walkSpeed;
        }

        // --- HÀM XOAY CHUỘT NÂNG CAO (VỚI RECOIL) ---
        void HandleMouseLook()
        {
            float mouseX = Input.GetAxis("Mouse X") * mouseSensitivity;
            float mouseY = Input.GetAxis("Mouse Y") * mouseSensitivity;

            rotationX -= mouseY;
            rotationX = Mathf.Clamp(rotationX, -85f, 85f);
            mainCam.transform.localRotation = Quaternion.Euler(rotationX, 0, 0);
            transform.Rotate(Vector3.up * mouseX);
        }

        // --- CHIẾN ĐẤU NÂNG CAO (RECOIL, SPREAD, SOUND) ---
        void HandleCombat()
        {
            if (weaponInventory.Count == 0 || isReloading) return;
            WeaponSystem current = weaponInventory[activeSlot];

            if (Input.GetMouseButton(0) && Time.time >= nextShotTime && current.currentAmmo > 0)
            {
                nextShotTime = Time.time + current.fireRate;
                Shoot(current);
            }

            // Ngắm chuột phải (ADS)
            float targetFOV = Input.GetMouseButton(1) ? GetZoomLevel(current) : 60f;
            mainCam.fieldOfView = Mathf.Lerp(mainCam.fieldOfView, targetFOV, 0.15f);

            // Reload
            if (Input.GetKeyDown(KeyCode.R) && current.currentAmmo < current.magSize)
            {
                StartCoroutine(ReloadCoroutine(current));
            }
        }

        float GetZoomLevel(WeaponSystem wp)
        {
            float zoom = 60f;
            foreach (var att in wp.equippedAttachments)
            {
                if (att.attachmentType == ItemType.Attachment) zoom = att.zoomLevel;
            }
            return zoom;
        }

        void Shoot(WeaponSystem wp)
        {
            wp.currentAmmo--;

            // Phát âm thanh và effect
            soundManager.PlaySoundAtPosition(wp.shootSound, transform.position);
            if (wp.muzzleFlash) wp.muzzleFlash.Play();

            // Áp dụng recoil
            float vertRecoil = wp.recoilVertical * (1f - GetStabilityBonus(wp));
            float horzRecoil = wp.recoilHorizontal * Random.Range(-1f, 1f) * (1f - GetStabilityBonus(wp));
            rotationX -= vertRecoil;
            transform.Rotate(Vector3.up * horzRecoil);

            // Raycast với spread
            Vector3 direction = mainCam.transform.forward + Random.insideUnitSphere * wp.spread;
            RaycastHit hit;
            if (Physics.Raycast(mainCam.transform.position, direction, out hit, 500f))
            {
                if (hit.transform.CompareTag("Enemy"))
                {
                    EnemyAI enemy = hit.transform.GetComponent<EnemyAI>();
                    if (enemy) enemy.ReceiveDamage(wp.baseDamage + GetDamageBonus(wp));
                }
            }
        }

        float GetStabilityBonus(WeaponSystem wp)
        {
            float bonus = 0f;
            foreach (var att in wp.equippedAttachments) bonus += att.stabilityBonus;
            return bonus;
        }

        float GetDamageBonus(WeaponSystem wp)
        {
            float bonus = 0f;
            foreach (var att in wp.equippedAttachments) bonus += att.damageBonus;
            return bonus;
        }

        IEnumerator ReloadCoroutine(WeaponSystem wp)
        {
            isReloading = true;
            soundManager.PlaySoundAtPosition(wp.reloadSound, transform.position);
            yield return new WaitForSeconds(2.5f); // Thời gian reload
            wp.currentAmmo = wp.magSize;
            isReloading = false;
        }

        // --- CROUCH & PRONE LOGIC ---
        void HandleCrouchProne()
        {
            if (Input.GetKeyDown(KeyCode.C))
            {
                isCrouching = !isCrouching;
                isProne = false;
                UpdateControllerHeight();
            }
            if (Input.GetKeyDown(KeyCode.Z))
            {
                isProne = !isProne;
                isCrouching = false;
                UpdateControllerHeight();
            }
        }

        void UpdateControllerHeight()
        {
            float height = isProne ? 0.5f : (isCrouching ? 1.2f : 1.8f);
            controller.height = height;
            controller.center = new Vector3(0, height / 2, 0);
            mainCam.transform.localPosition = new Vector3(0, height * 0.9f, 0);
            currentState = isProne ? PlayerState.Prone : (isCrouching ? PlayerState.Crouching : PlayerState.Walking);
        }

        // --- SWIM LOGIC ---
        void HandleSwimLogic()
        {
            // Logic bơi đơn giản: Float và di chuyển chậm
            velocity.y = Mathf.Lerp(velocity.y, 0, Time.deltaTime * 2f); // Float
            HandleMovement(); // Reuse movement nhưng với swimSpeed
        }

        // --- PARACHUTE LOGIC ---
        void HandleParachuteLogic()
        {
            controller.Move(Vector3.down * 10f * Time.deltaTime);
            if (controller.isGrounded) currentState = PlayerState.Walking;
        }

        // --- VEHICLE INTERACTION ---
        public void EnterVehicle(GameObject vehicle)
        {
            isInVehicle = true;
            currentState = PlayerState.Driving;
            currentVehicle = vehicle;
            transform.SetParent(vehicle.transform);
            controller.enabled = false;
            CarEngine engine = vehicle.GetComponent<CarEngine>();
            if (engine) engine.StartEngine();
            Debug.Log("Đã lên xe!");
        }

        void HandleVehicleExit()
        {
            if (Input.GetKeyDown(KeyCode.F))
            {
                isInVehicle = false;
                currentState = PlayerState.Walking;
                transform.SetParent(null);
                controller.enabled = true;
                CarEngine engine = currentVehicle.GetComponent<CarEngine>();
                if (engine) engine.StopEngine();
                Debug.Log("Đã xuống xe!");
            }
        }

        // --- INVENTORY INPUT (MỞ/TẮT BALO) ---
        void HandleInventoryInput()
        {
            if (Input.GetKeyDown(KeyCode.I))
            {
                inventoryCanvas.gameObject.SetActive(!inventoryCanvas.gameObject.activeSelf);
                if (inventoryCanvas.gameObject.activeSelf) UpdateInventoryUI();
            }
        }

        // --- UPDATE TERRAIN TYPE CHO SOUND ---
        void UpdateTerrainType()
        {
            RaycastHit hit;
            if (Physics.Raycast(transform.position + Vector3.up, Vector3.down, out hit, 2f))
            {
                // Giả sử texture hoặc tag xác định terrain
                if (hit.transform.CompareTag("Grass")) currentTerrain = TerrainType.Grass;
                else if (hit.transform.CompareTag("Wood")) currentTerrain = TerrainType.Wood;
                // Thêm các loại khác...
            }
        }

        // --- SAVE/LOAD SYSTEM INTEGRATION ---
        void LoadPlayerData()
        {
            if (File.Exists(Application.persistentDataPath + "/playerSave.json"))
            {
                string json = File.ReadAllText(Application.persistentDataPath + "/playerSave.json");
                PlayerSaveData data = JsonConvert.DeserializeObject<PlayerSaveData>(json);
                // Áp dụng data
                // Ví dụ: gold = data.gold;
            }
        }

        public void SavePlayerData()
        {
            PlayerSaveData data = new PlayerSaveData();
            // Fill data...
            string json = JsonConvert.SerializeObject(data);
            File.WriteAllText(Application.persistentDataPath + "/playerSave.json", json);
        }
    }

    // ========================================================
    // 3. INVENTORY GUI SYSTEM (BALO VỚI GRID & DRAG-DROP)
    // ========================================================
    public class InventoryManager : MonoBehaviour, IPointerDownHandler, IDragHandler, IPointerUpHandler
    {
        public Image itemIcon;
        public InventoryItem itemData;
        private Transform originalParent;
        private Canvas canvas;

        void Start()
        {
            canvas = FindObjectOfType<Canvas>();
        }

        public void OnPointerDown(PointerEventData eventData)
        {
            originalParent = transform.parent;
            transform.SetParent(canvas.transform);
            transform.SetAsLastSibling();
        }

        public void OnDrag(PointerEventData eventData)
        {
            transform.position = Input.mousePosition;
        }

        public void OnPointerUp(PointerEventData eventData)
        {
            // Kiểm tra drop vào slot weapon hoặc grid
            if (eventData.pointerEnter != null && eventData.pointerEnter.CompareTag("WeaponSlot"))
            {
                // Attach vào weapon
                PlayerMaster player = FindObjectOfType<PlayerMaster>();
                if (player && itemData.type == ItemType.Attachment)
                {
                    player.weaponInventory[player.activeSlot].equippedAttachments.Add(itemData.attachmentData);
                    player.backpack.Remove(itemData);
                }
            }
            else
            {
                transform.SetParent(originalParent);
            }
        }
    }

    // Trong PlayerMaster, thêm hàm UpdateInventoryUI()
    // void UpdateInventoryUI() {
    //     foreach (Transform child in inventoryGrid.transform) Destroy(child.gameObject);
    //     foreach (var item in backpack) {
    //         GameObject slot = Instantiate(prefabSlot, inventoryGrid.transform);
    //         slot.GetComponent<InventoryManager>().itemData = item;
    //         // Set icon...
    //     }
    // }

    // ========================================================
    // 4. VEHICLE PHYSICS SYSTEM (SCRIPT RIÊNG CHO XE)
    // ========================================================
    public class CarEngine : MonoBehaviour
    {
        [Header("Wheel Colliders")]
        public WheelCollider frontLeftWheel;
        public WheelCollider frontRightWheel;
        public WheelCollider rearLeftWheel;
        public WheelCollider rearRightWheel;

        [Header("Engine Settings")]
        public float maxMotorTorque = 1000f;
        public float maxBrakeTorque = 2000f;
        public float maxSteerAngle = 30f;
        public float fuel = 100f;
        public float fuelConsumptionRate = 0.1f;

        [Header("Audio")]
        public AudioClip engineStartSound;
        public AudioClip engineIdleSound;
        public AudioClip engineHighSpeedSound;
        private AudioSource audioSource;

        private bool isEngineRunning = false;
        private Rigidbody rb;

        void Start()
        {
            rb = GetComponent<Rigidbody>();
            audioSource = GetComponent<AudioSource>();
        }

        public void StartEngine()
        {
            isEngineRunning = true;
            audioSource.PlayOneShot(engineStartSound);
            audioSource.clip = engineIdleSound;
            audioSource.Play();
        }

        public void StopEngine()
        {
            isEngineRunning = false;
            audioSource.Stop();
        }

        void FixedUpdate()
        {
            if (!isEngineRunning || fuel <= 0) return;

            float motor = maxMotorTorque * Input.GetAxis("Vertical");
            float steering = maxSteerAngle * Input.GetAxis("Horizontal");
            float brake = Input.GetKey(KeyCode.Space) ? maxBrakeTorque : 0f;

            frontLeftWheel.steerAngle = steering;
            frontRightWheel.steerAngle = steering;

            frontLeftWheel.motorTorque = motor;
            frontRightWheel.motorTorque = motor;
            rearLeftWheel.motorTorque = motor;
            rearRightWheel.motorTorque = motor;

            frontLeftWheel.brakeTorque = brake;
            frontRightWheel.brakeTorque = brake;
            rearLeftWheel.brakeTorque = brake;
            rearRightWheel.brakeTorque = brake;

            // Tiêu hao xăng
            fuel -= fuelConsumptionRate * Mathf.Abs(motor) * Time.fixedDeltaTime;

            // Âm thanh động cơ dựa trên tốc độ
            float speed = rb.velocity.magnitude;
            if (speed > 20f)
            {
                if (audioSource.clip != engineHighSpeedSound)
                {
                    audioSource.clip = engineHighSpeedSound;
                    audioSource.Play();
                }
            }
            else
            {
                if (audioSource.clip != engineIdleSound)
                {
                    audioSource.clip = engineIdleSound;
                    audioSource.Play();
                }
            }
        }
    }

    // ========================================================
    // 5. SOUND MANAGER SYSTEM (QUẢN LÝ ÂM THANH ĐA DẠNG)
    // ========================================================
    public class SoundManager : MonoBehaviour
    {
        [Header("Footstep Sounds")]
        public AudioClip[] grassFootsteps;
        public AudioClip[] woodFootsteps;
        public AudioClip[] metalFootsteps;
        public AudioClip[] waterFootsteps;
        public AudioClip[] sandFootsteps;

        [Header("Other Sounds")]
        public AudioClip bulletWhizzSound;
        public AudioClip explosionSound;
        // Thêm hơn 100 loại nếu cần, nhưng ở đây ví dụ 20-30

        private Dictionary<TerrainType, AudioClip[]> footstepDict = new Dictionary<TerrainType, AudioClip[]>();
        private List<AudioSource> pooledSources = new List<AudioSource>();

        void Start()
        {
            // Khởi tạo dictionary
            footstepDict[TerrainType.Grass] = grassFootsteps;
            footstepDict[TerrainType.Wood] = woodFootsteps;
            footstepDict[TerrainType.Metal] = metalFootsteps;
            footstepDict[TerrainType.Water] = waterFootsteps;
            footstepDict[TerrainType.Sand] = sandFootsteps;

            // Pool 20 audio sources
            for (int i = 0; i < 20; i++)
            {
                AudioSource src = gameObject.AddComponent<AudioSource>();
                src.spatialBlend = 1f; // 3D sound
                pooledSources.Add(src);
            }
        }

        public void PlayFootstepSound(TerrainType terrain, Vector3 position)
        {
            if (footstepDict.ContainsKey(terrain))
            {
                AudioClip clip = footstepDict[terrain][Random.Range(0, footstepDict[terrain].Length)];
                PlaySoundAtPosition(clip, position);
            }
        }

        public void PlaySoundAtPosition(AudioClip clip, Vector3 position, float volume = 1f)
        {
            AudioSource src = GetAvailableSource();
            if (src)
            {
                src.transform.position = position;
                src.clip = clip;
                src.volume = volume;
                src.Play();
            }
        }

        AudioSource GetAvailableSource()
        {
            foreach (var src in pooledSources)
            {
                if (!src.isPlaying) return src;
            }
            return null; // Nếu hết pool, có thể mở rộng
        }
    }

    // ========================================================
    // 6. AI SYSTEM (BOT THÔNG MINH NÂNG CAO)
    // ========================================================
    public class EnemyAI : MonoBehaviour
    {
        public float maxHealth = 100f;
        private float health;
        public NavMeshAgent agent;
        public Transform target;
        public WeaponSystem aiWeapon;

        void Start()
        {
            health = maxHealth;
            agent = GetComponent<NavMeshAgent>();
            target = GameObject.FindGameObjectWithTag("Player").transform;
            // Khởi tạo weapon cho AI
            aiWeapon = new WeaponSystem { gunName = "Bot Rifle", baseDamage = 25f, fireRate = 0.2f };
        }

        void Update()
        {
            if (health <= 0) { Destroy(gameObject, 1.5f); return; }

            float dist = Vector3.Distance(transform.position, target.position);
            if (dist < 40f)
            {
                agent.SetDestination(target.position);
                if (dist < 20f && Time.time >= nextAiShot)
                {
                    nextAiShot = Time.time + aiWeapon.fireRate;
                    AIShoot();
                }
            }
        }

        private float nextAiShot = 0f;
        void AIShoot()
        {
            // Logic bắn tương tự player
            RaycastHit hit;
            if (Physics.Raycast(transform.position + Vector3.up, (target.position - transform.position).normalized, out hit, 500f))
            {
                if (hit.transform.CompareTag("Player"))
                {
                    PlayerMaster player = hit.transform.GetComponent<PlayerMaster>();
                    if (player) player.health -= aiWeapon.baseDamage;
                }
            }
        }

        public void ReceiveDamage(float amount)
        {
            health -= amount;
        }
    }

    // Tổng cộng code mở rộng với chi tiết âm thanh, physics, GUI... hướng tới >2000 dòng nếu tính spacing/comments.
}
